/**
 *
 * Copyright, KnowZero
 * Released under Apache 2.0 License.
 * Version 0.18-Alpha
 *
 * Contributing: https://github.com/KnowZero/tinymce4-languagetool
 */

tinymce.PluginManager.add('languagetool', function(editor, url) {


 // Load Stylesheet into UI
 var css_link = $("<link>", {
    rel: "stylesheet",
    type: "text/css",
    href: url + '/css/default.css'
 });
 css_link.appendTo('head');




 // Load ContextMenu into UI
 var context_menu = $('<div id="context-menu-nav"><ul id="context-menu-ul"></ul></div>');
 context_menu.appendTo('body');

 // Load Stylesheet into Editor DOM
 editor.on('init', function() {
    editor.dom.loadCSS(url + '/css/default.css');
 });


 var sgcheck = {}; // Active storage of changes
 var sgstore = { html:{}, text:{}, obj:{}, lt:{}, lock:{}, run:[], contextmenu:{}, ignore:{ once:{}, all:{}, rule:{} } }; // Universal Storage
 var timerRunner = 0; // Timer coundown for remote url (counts upwards though)
 var lastActive=0; // Last activity for hibernation
 var lastRun=0; // Keep track of when time last ran in epoch
 var newLineCheck=0; // Check if new line has been made

 var lt_remoteUrl = editor.getParam('lt_url') || "https://languagetool.org/api/v2/check";
 var lt_remoteTimer = editor.getParam('lt_timer') || 10000; // DO NOT CHANGE UNLESS YOU USE YOUR OWN URL!

 if ( /\/\/languagetool\.org/i.test( lt_remoteUrl ) && lt_remoteTimer < 10000 ) {
    if ( /\/\/\w+?\.github\.io/i.test( window.location.hostname ) ) {

    } else {
        lt_remoteTimer = 10000;
    }
 }

 var lt_setLanguage = editor.getParam('lt_lang') || "en-US";
 var lt_setHighlight = editor.getParam('lt_highlight') || {};
 var lt_debugLevel = editor.getParam('lt_debug') || 0;
 var lt_ignoreCallback = editor.getParam('lt_ignore_callback') || function () {};
 var lt_monopolizeHighlightContextMenu = editor.getParam('lt_monopolize_highlight_contextmenu') || true;
 var lt_highlightClick = editor.getParam('lt_highlight_click') || "right";
 var lt_fullMessage = editor.getParam('lt_full_message') || false;




 sgstore['ignore']['all']=editor.getParam('lt_ignore_words') || {};
 sgstore['ignore']['rule']=editor.getParam('lt_ignore_rules') || {};


 lt_setHighlight['default'] = lt_setHighlight['default'] || "hly1";
 lt_setHighlight['misspelling'] = lt_setHighlight['misspelling'] || "hlr1";
 lt_setHighlight['grammar'] = lt_setHighlight['grammar'] || "hlg1";
 lt_setHighlight['typographical'] = lt_setHighlight['typographical'] || "hlb1";
 lt_setHighlight['style'] = lt_setHighlight['style'] || "hln1";
 lt_setHighlight['duplication'] = lt_setHighlight['duplication'] || "hlo1";
 lt_setHighlight['inconsistency'] = lt_setHighlight['inconsistency'] || "hlp1";
 




var buttonMenu = [
{ text: "Configuration", onclick: function() {  

    var configWindow = [];

    configWindow.push(
                                        {
                                            title: 'Ignore List',
                                            type: "form",
                                            items: [
                                                { name: 'ignore_rules', id: 'lt_ignoreRulesCfg', type: 'selectbox', size: 10, label: 'Rules', options: Object.keys(sgstore['ignore']['rule']) },
                                                {
                                                    type   : 'button',
                                                    name   : 'button',
                                                    label  : ' ',
                                                    text   : 'Remove Ignoring Rule',
                                                    onclick: function(e) { 
                                                        var val = $("#lt_ignoreRulesCfg").val(); 
                                                        delete(sgstore['ignore']['rule'][val]);  
                                                        lt_ignoreCallback.call('removeRule',val);   
                                                        $("#lt_ignoreRulesCfg option:selected").remove();  
                                                    }
                                                },

                                                { name: 'ignore_words', id: 'lt_ignoreWordsCfg', type: 'selectbox', size: 10, label: 'Words', options: Object.keys(sgstore['ignore']['all']) },

                                                {
                                                    type   : 'button',
                                                    name   : 'button',
                                                    label  : ' ',
                                                    text   : 'Remove Ignoring Word',
                                                    onclick: function(e) { 
                                                        var val = $("#lt_ignoreWordsCfg").val(); 
                                                        delete(sgstore['ignore']['all'][val]);  
                                                        lt_ignoreCallback.call('removeWord',val);   
                                                        $("#lt_ignoreWordsCfg option:selected").remove();  
                                                    }
                                                }

                                            ]
                                        }
    );

/*
    configWindow.push(

        {
            title: "Preferences",
            type: "form",
            items: [
                { name: 'set_language', id: 'lt_setLanguage', type: 'selectbox', size: 1, label: 'Set Language', options: [] }
            ]
        }

    );
*/


            editor.windowManager.open({
                title: 'Configuration',
                bodyType: 'tabpanel',
                body: configWindow,
                onsubmit: function(e) {


 

                }
            });


   } },
];
var buttonArgs = {
        tooltip: 'Spellcheck',
        onclick: function() {},
        type: 'menubutton',
        icon: 'spellchecker',
        menu: buttonMenu
      };


      editor.addButton('languagetool', buttonArgs);






 var timerFunc = function() {

    timerRunner+=100;
    lastActive+=100;

    $.each(sgstore['run'], function(i,val) {
        sgstore['run'][i].func();
    });
    sgstore['run']=[];

    if ( newLineCheck == 1 && (lastRun + lt_remoteTimer) < (new Date).getTime() ) {
        lt_debug('INFO|LAST RUN WITHIN TIMER',4);
        timerRunner=lt_remoteTimer;
    }

    if ( timerRunner >= lt_remoteTimer ) {
        newLineCheck=0;
        timerRunner=0;

        var data = {
            text: "",
            language: lt_setLanguage
        };


        if ( editor.getParam('lt_postdata') != undefined  ) {

            $.each(editor.getParam('lt_postdata'), function (key,val) {
                data[key]=val;
            });

        }
        if ( data['disabledRules'] == undefined ) {
            data['disabledRules']=''+Object.keys(sgstore['ignore']['rule']).join(',');

        } else {
            data['disabledRules']+=','+Object.keys(sgstore['ignore']['rule']).join(',');
        }





        $.each(sgcheck, function(key,val) {

            if ( sgstore['lock'][key] != 1  ) {

                if ( val.length >= 2 && val != sgstore['text'][key] && $(sgstore['obj'][key]).data('UUID') == key  ) {
                    data['text']=data['text']+val+"\t("+key+")\n\n";
                }
                sgstore['text'][key] = '' + sgcheck[key];
                delete(sgcheck[key]);
            }


        });

        lt_debug( "INFO|SENT-TEXT="+data['text'], 4 );

        if ( data['text'] != '' ) {

            lastRun = (new Date).getTime();
            $.ajax({
                type: "POST",
                url: lt_remoteUrl,
                data: data,
                indexValue: { text: data['text']},
                //contentType: "multipart/form-data"
                dataType: "json",
                success: function(data){

                    var json = data;
                    var mytext = this.indexValue.text;

                    var uuidcount={};
                    var bookmark = editor.selection.getBookmark();




                    mytext.replace(/\t\(([a-f0-9-]{36})\)\n\n/,function (pmatch,p1) { 
                        var tempid = p1; 

                        var temphtml = lt_clearHighlighter( lt_text($(sgstore['obj'][tempid]).html()) );


                        $(sgstore['obj'][tempid]).html( temphtml );
    
                        return pmatch; 
                    });

                    var fmatch={};
                    var locklist={};

                    $.each(json['matches'],function(i,item) {

                        var hclass = lt_setHighlight['default'];

                        if ( lt_setHighlight[ item['rule']['issueType'] ] != undefined ) {
                            hclass = lt_setHighlight[ item['rule']['issueType'] ];
                        }


                        var tempstr = mytext.substr( item['offset'] );

                        

                        var uuid;
                        var templen;

                        var tempword;



                        var tempword = tempstr.substr( 0, item['length'] );





                        tempstr.replace(/^(.*?\t)\(([a-f0-9-]{36})\)\n\n/,function (pmatch,p1,p2) {  uuid = p2; return pmatch; });

                        mytext.replace( new RegExp("(?:^|\n\n)(.*?\("+uuid+"\))"),function(pmatch,p1) {  templen=mytext.indexOf(p1); return pmatch;  } );


                        lt_debug('INFO|WORD='+tempword+'|OFFSET='+item['offset']+'|LEN='+item['length']+'|ADJLEN='+templen,4);

                        if ( uuid != undefined && sgstore['ignore']['all'][tempword] == undefined && (sgstore['ignore']['once'][uuid] == undefined || sgstore['ignore']['once'][uuid][tempword] == undefined) )  {




                            item['offset']-=templen;
                            lt_debug( "TRACE|OFFSET="+item['offset']+'='+templen, 6 );

                            if ( fmatch[ uuid ] == undefined ) {
                                sgstore['lt'][ uuid ]={};
                                fmatch[ uuid ]=1;

                            }

                            sgstore['lt'][ uuid ][i]=item;
                            sgstore['lt'][ uuid ][i]['word']=tempword;

                            lt_applyHighlighter( editor, sgstore['obj'][ uuid ], i, tempword, item['rule']['id'], hclass, item['offset'], item['offset']+item['length']  );
                            locklist[ uuid ]=1;


                        }

                    });


                    $.each(locklist,function (key,val) {
                        lt_lock(0, key );
                    });

                    editor.selection.moveToBookmark(bookmark); 

                    

                },
                failure: function(errMsg) {
                    lt_debug('ERROR|'+errMsg,2);
                }
            });
        }


    }
 lt_timer(1);
 };


 lt_timer(1);


 editor.on('PastePreProcess', function (e) {


 });

 editor.on('PastePostProcess', function (e) {

 });


 editor.on('keyDown',function(e) {

 var key = e.which || e.keyCode || 0;

    if ( key == 13 ) {
        
        var mynode = tinyMCE.activeEditor.selection.getNode();

        var mypnode=lt_find_parent_node(mynode);



    
        var uuid = $(mypnode).data('UUID');
    
        lt_debug('INFO|ENTER='+uuid+'|'+mynode.nodeName,4);
    
        sgcheck[ uuid ]=lt_text($(mypnode).text());
        sgstore['obj'][ uuid ]=mypnode;
        sgstore['html'][ uuid ]=lt_text($(mypnode).html());
        newLineCheck=1;
        lt_timer(0); // Resume if idle

        if ( $(mynode).data('hid') != undefined ) {
            $(mynode).removeData('hid');
            $(mynode).removeClass();
            $(mynode).addClass('hlt1');
        }

    }

 });


 editor.on('keyPress',function(e) {

    var key = e.which || e.keyCode || 0;

    if ( key == 46  // .
        || key == 33    // !
        || key == 63    // ?
    ) { 
        var mynode = tinyMCE.activeEditor.selection.getNode();

        var mypnode=lt_find_parent_node(mynode);


        var uuid = $(mypnode).data('UUID');

        lt_debug('INFO|ENDSENT='+uuid,4);

        sgcheck[ uuid ]=lt_text($(mypnode).text());
        sgstore['obj'][ uuid ]=mypnode;
        sgstore['html'][ uuid ]=lt_text($(mypnode).html());
        newLineCheck=1;
        lt_timer(0); // Resume if idle


            if ( $(mynode).data('hid') != undefined ) {
                $(mynode).removeData('hid');
                $(mynode).removeClass();
                $(mynode).addClass('hlt1');
            }

        } else if ( key == 32 // SPACE
            || key == 44  // ,
        ) { 
        var mynode = tinyMCE.activeEditor.selection.getNode();

        var mypnode=lt_find_parent_node(mynode);

        if ( $(mynode).data('hid') != undefined ) {
          $(mynode).removeData('hid');
          $(mynode).removeClass();
          $(mynode).addClass('hlt1');
        }



    }

 });


var lastnode;

 editor.on('NodeChange', function(e) {
    lt_timer(0); // Resume if idle

    var mynode = e.element;




    var mypnode=lt_find_parent_node(mynode);

    var uuid = $(mypnode).data('UUID');

    lt_debug('TRACE|NODECHANGE=' + mynode.nodeName + '=' + uuid ,6);

    if ( mypnode.id == 'mcepastebin' ) {

        return;

    }


    if ( uuid == undefined ) {
        uuid = getUUID();
        $(mypnode).data('UUID', uuid );

    }

    if (  $(mypnode).is(lastnode) ) {
        
    } else {



        var lastuuid = $(lastnode).data('UUID');


    sgcheck[ lastuuid ]=lt_text($(lastnode).text());
    sgstore['obj'][ lastuuid ]=lastnode;
    sgstore['html'][ lastuuid ]=lt_text($(lastuuid).html());
    lastnode = mypnode;

    lt_debug('DEBUG|NODE='+mypnode.nodeName+'('+mynode.nodeName+')='+uuid+'='+lt_text($(mypnode).text())+'|LEN='+lt_text($(mypnode).text()).length , 5 );

    }
 });



 editor.on('SetContent', function(e) {

    
    lt_new_content_process(e);


 });

 editor.on('GetContent', function(e) {
    lt_debug('INFO|GETCONT='+e, 4);
 });


 editor.on('mousedown', function(e) {

   
console.log(e.which);

    if (!$(e.target).parents("#context-menu-nav").length > 0) {
        $("#context-menu-nav").hide(100);
    }

    if ( lt_highlightClick == 'left' && e.which == 1 ) {
        lt_openContextMenu(e);
    }


 });

 $(document).bind("mousedown", function (e) {
    
    // If the clicked element is not the menu
    if (!$(e.target).parents("#context-menu-nav").length > 0) {
       
        var uuid = $(this).data("ident-uuid");
        lt_debug( 'TRACE|CONTEXT-MENU-NOTCLICK=UUID='+uuid, 6 );
        sgstore['lock'][uuid]=0;

        // Hide it
        $("#context-menu-nav").hide(100);
    }
 });




 editor.on('contextmenu', function(e) {
 if ( lt_highlightClick == 'right' ) {

        
        if (  lt_monopolizeHighlightContextMenu == true && lt_openContextMenu(e) == 1 ) {
            $(tinymce.DOM.doc).find(".mce-contextmenu").hide();
            return false;
        }


    
 }
 });



 // If the menu element is clicked
 $(document).on('click','.context-menu-item',function(){
    lt_debug( 'INFO|CONTEXT-ITEM='+$(this).data("ident-uuid")+'='+$(this).data("ident-hid")+'='+$(this).data("ident-value"), 4 );

	editor.undoManager.add();

    //editor.execCommand('mceRemoveNode',false, this );
    //editor.dom.remove('*[data-UUID="'+$(this).data("ident-uuid")+'"] *[data-hid="'+$(this).data("ident-hid")+'"]');

    var uuid = $(this).data("ident-uuid");
    sgstore['lock'][uuid]=0;

    //var mynode = editor.selection.getNode();
    var mynode = sgstore['contextmenu'];

    if ( mynode.nodeName == 'SPAN' && /hl[rgnybop][0-9]/.test($(mynode).attr('class')) == true ) {


        sgstore['run'].push({ 
            node: mynode, value:$(this).data("ident-value"), 
            func: function () {
                mynode=this.node;
                $( mynode ).replaceWith( this.value );
                sgcheck[ uuid ]=lt_text($(mynode).parent().text());
                sgstore['html'][ uuid ]=lt_text($(mynode).parent().html());
            }
        });
    }



//editor.dom.remove(this);

//editor.execCommand('mceReplaceContent',false,$(this).data("ident-value") );

  
    // Hide it AFTER the action was triggered
    $("#context-menu-nav").hide(100);
 });


 // If the menu element is clicked
 $(document).on('click','.context-menu-ignore',function(){
    lt_debug( 'INFO|CONTEXT-IGNORE='+$(this).data("ident-uuid")+'='+$(this).data("ident-hid")+'='+$(this).data("ident-value"), 4 );

	//editor.undoManager.add();

    var uuid = $(this).data("ident-uuid");
    var hid = $(this).data("ident-hid");
    sgstore['lock'][uuid]=0;

    //var mynode = editor.selection.getNode();
    var mynode = sgstore['contextmenu'];

    if ( mynode.nodeName == 'SPAN' && /hl[rgnybop][0-9]/.test($(mynode).attr('class')) == true ) {
        if ( $(this).data("ident-value") == 'once' ) {
            if ( sgstore['ignore']['once'][uuid] == undefined ) {
                sgstore['ignore']['once'][uuid]={};
            }


            sgstore['ignore']['once'][uuid][sgstore['lt'][uuid][hid]['word']]=1;

            var mynode = sgstore['contextmenu'];

            if ( mynode.nodeName == 'SPAN' && /hl[rgnybop][0-9]/.test($(mynode).attr('class')) == true ) {


                sgstore['run'].push({ 
                    node: mynode,
                    func: function () {
                        mynode=this.node;
                        $( mynode ).replaceWith( $(mynode).html() );
                        sgcheck[ uuid ]=lt_text($(mynode).parent().text());
                        sgstore['html'][ uuid ]=lt_text($(mynode).parent().html());
                    }
                });
            }


        } else if ( $(this).data("ident-value") == 'all' ) {
            lt_debug('INFO|IGNORE-ALL='+sgstore['lt'][uuid][hid]['word'], 4  );
            sgstore['ignore']['all'][sgstore['lt'][uuid][hid]['word']]=1;

            sgstore['run'].push({ 
                node: mynode,
                func: function () {

                    $(tinymce.activeEditor.getBody()).find( 'span[data-word="'+window.btoa( encodeURIComponent(sgstore['lt'][uuid][hid]['word']) )+'"]' ).each(function () {
                        $(this).replaceWith( $(this).html() );

                    });
                    lt_ignoreCallback.call('addWord',sgstore['lt'][uuid][hid]['rule']['id']);
                }

            });

            
        } else if ( $(this).data("ident-value") == 'rule' ) {
            editor.windowManager.open({
                title: 'Confirm',
                body: [
                    {type: 'textbox', name: 'uuid', value:uuid, style: 'display:none'},
                    {type: 'label', label: 'Are you sure you wish to ignore this rule going forward?'},
                    {type: 'textbox', name: 'hid', value:hid, style: 'display:none'}   
                ],
                onsubmit: function(e) {


                    sgstore['run'].push({ 
                        node: mynode,
                        func: function () {
                            sgstore['ignore']['rule'][sgstore['lt'][e.data.uuid][e.data.hid]['rule']['id']]=1;

                            $(tinymce.activeEditor.getBody()).find( 'span[data-rule="'+sgstore['lt'][e.data.uuid][e.data.hid]['rule']['id']+'"]' ).each(function () {
                                $(this).replaceWith( $(this).html() );
                        
                            });

                            lt_ignoreCallback.call('addRule',sgstore['lt'][e.data.uuid][e.data.hid]['rule']['id']);

                        }
                    });

                }
            });

        }

    }


  
    // Hide it AFTER the action was triggered
    $("#context-menu-nav").hide(100);
 });


 editor.on('PreInit', function () {
    editor.serializer.addNodeFilter('span', function (nodes) {
        var i = nodes.length;

        while (i--) {
            var node = nodes[i];

            if ( /hl[rgnybopt][0-9]/.test(node.attr('class')) == true ) {
                node.unwrap();
            }


        }

    });
 });



 var lut = []; for (var i=0; i<256; i++) { lut[i] = (i<16?'0':'')+(i).toString(16); }
 function getUUID()
 {
    var d0 = Math.random()*0xffffffff|0;
    var d1 = Math.random()*0xffffffff|0;
    var d2 = Math.random()*0xffffffff|0;
    var d3 = Math.random()*0xffffffff|0;
    return lut[d0&0xff]+lut[d0>>8&0xff]+lut[d0>>16&0xff]+lut[d0>>24&0xff]+'-'+
    lut[d1&0xff]+lut[d1>>8&0xff]+'-'+lut[d1>>16&0x0f|0x40]+lut[d1>>24&0xff]+'-'+
    lut[d2&0x3f|0x80]+lut[d2>>8&0xff]+'-'+lut[d2>>16&0xff]+lut[d2>>24&0xff]+
    lut[d3&0xff]+lut[d3>>8&0xff]+lut[d3>>16&0xff]+lut[d3>>24&0xff];
 }

 function insertAt (mystr, CharToInsert,Position) {
     return mystr.slice(0,Position) + CharToInsert + mystr.slice(Position)
 }



 function lt_clearHighlighter (content) {

    var temphtml= content.replace(/<span class="hl[rgnybopt][0-9]" data-hid="[0-9]+" data-word="[a-zA-Z0-9\/=+]+" data-rule="[a-zA-Z0-9_]+">(.*?)<\/span>/g, function(match,p1) { return p1; });
    lt_debug('TRACE|CLEAR='+temphtml,6);
    return temphtml;

 }

 function lt_applyHighlighter ( editor, myobj, myid, myword, myrule, myclass , mystart, myend ) {
    var alist = {};

    var mytext = lt_text($(myobj).text());
    var myhtml = lt_text($(myobj).html());

    lt_debug( 'TRACE|HIGHLIGHT-HTML-PRE='+myobj+'='+myhtml+'=', 6);

    var patt = /\<.*?\>|&(?:nbsp|amp|quot|copy|reg|[gl]t|\#[0-9a-f]+);/ig;

    while (match = patt.exec(myhtml)) {
        var topt;

        if (match[0].substr(0,1) == '<') {

        topt = patt.lastIndex - match.index;
        } else {
        topt= patt.lastIndex - match.index - 1;
        }

        if ( mystart >= match.index ) {
            mystart =  mystart + topt;
        }
 
        if ( myend > match.index ) {
            myend =  myend + topt;
        }

    }

    var myspan = '<span class="'+myclass+'" data-hid="'+myid+'" data-word="'+window.btoa( encodeURIComponent(myword) )+'" data-rule="'+myrule+'">';

    myhtml = insertAt(myhtml, myspan,mystart);
    myhtml = insertAt(myhtml, '</span>',myend+myspan.length  );

//>var rspan = new RegExp('(('+myspan+').*?)(\<\/.*?\>)(.*?\<\/span\>)');
//>myhtml = myhtml.replace(rspan,function(match,p1,p2,p3,p4) { 
//>return p1+'</span>'+p3+''+p2+''+p4 
//>} );


    lt_debug( 'TRACE|HIGHLIGHT-HTML-POST='+ myhtml, 6 );

    $(myobj).html( myhtml );

//var astart = substr(mytext, 0, mystart).split(/[^a-zA-Z'0-9]/);



//$.each(atext, function () {


//});

 }

 function lt_lock (mode, uuid) {


 }


function lt_text (str) {


str=encodeURIComponent(str);
var reg = /\%EF\%BB\%BF/g;

return decodeURIComponent(str.replace(reg, ''));

}

function lt_debug (content,level) {
    if ( lt_debugLevel >= (level||1) ) {
        console.log(content);
    }
}

 function lt_timer(mode) {
//lt_debug("mode="+mode);
    if ( mode == 1 && lastActive < (30*1000) ) {
        setTimeout(timerFunc, 100);
    } else if ( mode == 0 && lastActive >= (30*1000) ) {
        lastActive=0;
        setTimeout(timerFunc, 100);
    } else if ( mode == 0 ) {

    }

 }

 function lt_find_parent_node (mynode) {
    

    if ( mynode.nodeName == 'HTML' || mynode.nodeName == 'BODY' ) {
        return {};
    }
  
    var mypnode = mynode;

    var pfind = 0;
    while ( pfind != 1 ) {


        //if ( mynode.nodeName == 'STRONG' || mynode.nodeName == 'EM' || (mynode.nodeName == 'SPAN' && /hl[rgnybop][0-9]/.test($(mynode).attr('class')) == false ) ) {
        if ( $(mypnode).data('UUID') == undefined ) {        

            if  ( mypnode.parentNode.nodeName == 'BODY' ) {

                var uuid = getUUID();
                $(mypnode).data('UUID', uuid );
                return mypnode;
            } else {
                mypnode = mypnode.parentNode
            }

        } else {
            pfind=1;
        }
    }
    return mypnode;
 }




 function lt_new_content_process (e) {

    var pnode = tinymce.activeEditor.getBody();

    lt_debug('TRACE|SETBODY='+$(pnode).html(),6);

    //$(pnode).children().each(function () {
    $(pnode).find("*").each(function() {

    var mynode=this;

    var nodeExc = { "TABLE":1, "TBODY":1, "TR":1, "TH":1  };




    if ( $(mynode).css('display') == 'inline' || nodeExc[mynode.nodeName] == 1 ) {




    } else {

        var tcontinue = 0;
        $.each(mynode.childNodes,function (i,cnode) {

            if ( cnode.nodeType == 3 ) {
                tcontinue=1;
            } else if ( cnode.nodeType == 1 && $(cnode).css('display') == 'inline' ) {
                tcontinue=1;
            }

        });

        if ( tcontinue == 1 ) {

            var uuid = $(mynode).data('UUID');
            lt_debug("INFO|SET CONTENT="+mynode.nodeName+"="+uuid,  4);

            if ( uuid == undefined ) {
                uuid = getUUID();
                $(mynode).data('UUID', uuid );
                lt_debug("TRACE|SET CONTENT2="+mynode.nodeName+"="+uuid+"="+$(mynode).html(),  4);
                sgcheck[ uuid ]=lt_text($(mynode).text());
                sgstore['obj'][ uuid ]=mynode;
                sgstore['html'][ uuid ]=lt_text($(mynode).html());
            }   else if ( $(mynode).is(lastnode) ) {
                sgcheck[ uuid ]=lt_text($(mynode).text());
                sgstore['obj'][ uuid ]=mynode;
                sgstore['html'][ uuid ]=lt_text($(mynode).html());
            }
        
        }

}

 });

 }


 function lt_openContextMenu (e) {

    var mynode = e.target;
    var mypnode = mynode.parentNode;

    var nfind = 0;


    //if ( mypnode.nodeName == 'BODY' || mynode.nodeName == 'HTML' ) {
    //    return;
    //}




    var mypnode=lt_find_parent_node(mynode);



    while ( nfind != 1 ) {
        if ( mynode.nodeName == 'STRONG' || mynode.nodeName == 'EM' || (mynode.nodeName == 'SPAN' && /hl[rgnybopt][0-9]/.test($(mynode).attr('class')) == false ) ) {
 
            mynode = mynode.parentNode;
        } else {
            nfind=1;
        }
    }


    lt_debug('TRACE|CONTEXT-MENU='+mynode.nodeName , 6 );



    if ( /hl[rgnybop][0-9]/.test($(mynode).attr('class')) == true ) {
        sgstore['contextmenu']=mynode;

        var uuid = $(mypnode).data('UUID');
        sgstore['lock'][uuid]=1;

        var hid = $(mynode).data('hid');

        lt_debug('INFO|CONTEXT-MENU-NEW='+mynode.nodeName+'|'+uuid+'='+hid+'|' , 4 );
        e.preventDefault();

        $("#context-menu-ul").empty();   

  

        $("#context-menu-ul").append(
            $('<li/>', {
                "html": ( (sgstore['lt'][uuid][hid]['shortMessage'] == '' || lt_fullMessage == true ) ? sgstore['lt'][uuid][hid]['message']:sgstore['lt'][uuid][hid]['shortMessage']),
                "class":"context-menu-header"
            })
        );

        var countSuggestions = 0;
        $.each(sgstore['lt'][uuid][hid]['replacements'],function(key,val) {

            if ( countSuggestions < 10 ) {
                $("#context-menu-ul").append(
                    $('<li/>', {
                        "html": val['value'],
                        "class":"context-menu-item",
                        "data-ident-uuid": uuid,
                        "data-ident-hid": hid,
                        "data-ident-value": val['value']
                    })
                );
            } else {

                if ( countSuggestions == 10 ) {
                    $("#context-menu-ul").append(
                        $('<li/>', {
                            "html": "More...<ul id='context-submenu-ul'></ul>",
                            "id":"context-menu-item-list",
                            "data-ident-uuid": uuid,
                            "data-ident-hid": hid,
                            "data-ident-value": val['value']
                        })
                    );
                }
                $("#context-submenu-ul").append(
                    $('<li/>', {
                        "html": val['value'],
                        "class":"context-menu-item",
                        "data-ident-uuid": uuid,
                        "data-ident-hid": hid,
                        "data-ident-value": val['value']
                    })
                );
            }
            countSuggestions++;

        });    


        $("#context-menu-ul").append(
            $('<li/>', {
                "html": "-",
                "class":"context-menu-break",

            })
        );

        $("#context-menu-ul").append(
            $('<li/>', {
                "html": "Ignore Once",
                "class":"context-menu-ignore",
                "data-ident-uuid": uuid,
                "data-ident-hid": hid,
                "data-ident-value": "once"
            })
        );

        $("#context-menu-ul").append(
            $('<li/>', {
                "html": "Ignore All",
                "class":"context-menu-ignore",
                "data-ident-uuid": uuid,
                "data-ident-hid": hid,
                "data-ident-value": "all"
            })
        );
        $("#context-menu-ul").append(
            $('<li/>', {
                "html": "Ignore Rule",
                "class":"context-menu-ignore",
                "data-ident-uuid": uuid,
                "data-ident-hid": hid,
                "data-ident-value": "rule"
            })
        );


        var pageX = e.clientX + $('#'+tinymce.activeEditor.id+'_ifr').offset().left;
        var pageY = e.clientY + $('#'+tinymce.activeEditor.id+'_ifr').offset().top;

        var mwidth = $("#context-menu-nav").width();
        var mheight =$("#context-menu-nav").height();
        var screenWidth = $(window).width();
        var screenHeight = $(window).height();

        $("#context-submenu-ul").removeClass('context-submenu-ul-right');
        $("#context-submenu-ul").addClass('context-submenu-ul-left');
        $("#context-submenu-ul").removeClass('context-submenu-ul-bottom');
        $("#context-submenu-ul").addClass('context-submenu-ul-top');


        var scrTop = $(window).scrollTop();
        lt_debug( "DEBUG|1="+pageX+"="+pageY+'='+$('#'+tinymce.activeEditor.id+'_ifr').contents().scrollTop()+'='+$('#'+tinymce.activeEditor.id+'_ifr').offset().top+'='+e.clientY, 5 );
        // right of window
        if(pageX+mwidth > screenWidth){

            pageX = (pageX-mwidth);
            $("#context-submenu-ul").removeClass('context-submenu-ul-left');
            $("#context-submenu-ul").addClass('context-submenu-ul-right');
        }

        // bottom of window
        if(pageY+mheight > screenHeight+scrTop){

            pageY = pageY-mheight ;
            $("#context-submenu-ul").removeClass('context-submenu-ul-top');
            $("#context-submenu-ul").addClass('context-submenu-ul-bottom');
        }


        lt_debug( "DEBUG|2="+pageX+"="+pageY, 5 );




        $("#context-menu-nav").finish().toggle(100).
        css({
            top: pageY + "px",
            left: pageX + "px"
        });

        return 1;
    }

    return 0;

 }






});


